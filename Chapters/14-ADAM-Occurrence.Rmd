# ADAM for Intermittent Demand {#ADAMIntermittent}
So far we have discussed data that has regular occurrence. This is a characteristic of a well established product that is sold every observation. For example, daily sales of bread in a supermarket would have this regularity. However, there are time series, where non-zero values do not happen on every observation. In the context of demand forecasting, this is called "**Intermittent demand**". The conventional example of such demand is monthly sales of jet engines: they will contain a lot of zeroes, when nobody buys the product and then all of a sudden several units, again followed by zeroes.

One of the simplest definitions of intermittent demand is that *it is the demand that happens at irregular frequency*. While at a first glance it might seem that it is an exotic problem, intermittent demand can be encountered in many areas, when the frequency of measurement is high enough. For example, daily sales of a specific type of tomatoes in a store might exhibit regular demand, but the same sales on hourly or minute frequency would exhibit intermittence. So, the problem is universal and might appear in almost any context.

Sometimes the term "count data" (or "integer-valued data") is used in a similar context, but there is a difference between this term and intermittent data. "Count data" implies that demand can take integer values only and can be typically modelled via Poisson, Binomial or Negative Binomial distributions. It does not necessarily contain zeroes and does not explicitly allow demand to happen at random. If there are zeroes, then it is assumed that they are just one of the possible values of a distribution. In case of intermittent demand, we explicitly acknowledge that demand might not happen, but if it happens then the demand size will be greater than zero. Furthermore, intermittent demand does not necessarily need to be integer-valued. For example, daily energy consumption for charging electric vehicles would typically be intermittent (because the vehicle owners do not charge them every day), but the non-zero consumption will not be integer. Having said that, count distributions can be used in some cases of intermittent demand, but they do not necessarily always provide a good approximation of complex reality.

Before we move towards the proper discussion of the topic in context of ADAM, we should acknowledge that at the heart of what follows, there lies the following model [@Croston1972]:
\begin{equation}
  y_t = o_t z_t ,
  (\#eq:IntermittentDemandModel)
\end{equation}
where $o_t$ is the demand occurrence variable, which can be either zero or one and has some probability of occurrence, $z_t$ is the demand sizes captured by a model (for example, ADAM ETS) and $y_t$ is the final observed demand. This model in context of intermittent demand was originally proposed by @Croston1972, but similar models (e.g. Hurdle and Zero Inflated Poisson) exist in other, non-forecasting related contexts.

In this chapter we will discuss the intermittent state space model that \@ref(eq:IntermittentDemandModel), both parts of which can be modelled via ADAM models, and we will see how they can be used, what they imply and how they connect to the convetional regular demand. If ETS model is used for $z_t$ then \@ref(eq:IntermittentDemandModel) is called iETS. So, iETS(M,N,N) model refers to the intermittent state space model, where demand sizes are modelled via ETS(M,N,N). If the discussion is focused on demand occurrence part of the model, we will use ``oETS'' instead. While ARIMA can be used in this context as well, it is not yet implemented for the occurrence part of the model. So we will focus the discussio on ADAM ETS. Furthermore, depending on how the occurrence part is modelled, these notations can be expanded to include references to specific parts of the occurrence part of the model. This is discussed in the Subsection \@ref(ADAMOccurrence). All of this is based on @Svetunkov2019a.


## Occurrence part of the model {#ADAMOccurrence}
The general model \@ref(eq:IntermittentDemandModel) assumes that demand occurs randomly and that the variable $o_t$ can be either zero (no demand) or one (there is some demand). While this process can be modelled using different distributions, we propose using Bernoulli with a time varying probability (in the most general case):
\begin{equation}
    o_t \sim \text{Bernoulli} \left(p_t \right) ,
  (\#eq:OccurrenceModelBernoulli)
\end{equation}
where $p_t$ is the probability of occurrence. In this section we will discuss different types of models for this probability. Each one has some idea behind it, and there are different mechanisms of the model construction, estimation, error calculation, update of the states and the generation of forecasts for each of them.

The occurrence part of the model can be estimated via the likelihood, which in the most general case is:
\begin{equation}
	\ell \left(\boldsymbol{\theta} | o_t \right) = {\sum_{o_t=1}} \log(\hat{p}_t) + {\sum_{o_t=0}} \log(1-\hat{p}_t) ,
  (\#eq:oETSLikelihood)
\end{equation}
where $\hat{p}_t$ is the in-sample conditional one step ahead expectation of the probability on observation $t$, given the information on observation $t-1$, which depends on the vector of estimated parameters $\boldsymbol{\theta}$. The derivation of the formula \@ref(eq:oETSLikelihood) is discussed in more detail later in this chapter.

In order to demonstrate the difference between specific types of oETS models, we will use the following artificial data:
```{r artificialData}
y <- ts(c(rpois(20,0.25),rpois(20,0.5),rpois(20,1),rpois(20,2),rpois(20,3),rpois(20,5)))
```

Here how the data looks like:

```{r}
plot(y)
```

The probability of occurrence in this model increases together with the demand sizes. This example corresponds to the situation of intermittent demand of a product becoming regular.


### Fixed probability model, iETS$_F$
We start with the simplest case of the fixed probability of occurrence, iETS$_F$ model:
\begin{equation}
	o_t \sim \text{Bernoulli}(p) ,
	(\#eq:oETSFixed)
\end{equation}
This model assumes that demand happens with the same probability no matter what. This might sound exotic, because in practice, there might be many factors influencing customers' desire to purchase and the impact of these factors might change over the year. But this is a very basic model, which at least can be used as a benchmark on intermittent demand data. Furthermore, it might be suitable for modelling demand on expensive high-tech products, such as jet engines, which is ``very slow'' in its nature and typically does not evolve much over time.

When estimated via maximisation of likelihood function \@ref(eq:oETSLikelihood), the probability of occurrence is equal to:
\begin{equation}
	\hat{p} = \frac{T_1}{T},
	(\#eq:oETSFixedProbabilityMLE)
\end{equation}
where $T_1$ is the number of non-zero observations and $T$ is the number of all the available observations in sample.

The occurrence part of the model, oETS$_F$ can be constructed using `oes()` function from `smooth` package:

```{r iETSFExample1}
oETSFModel1 <- oes(y, occurrence="fixed", h=10, holdout=TRUE)
oETSFModel1
plot(oETSFModel1)
```

The plot above demonstrates the dynamics of the occurrence variable $o_t$ and the fitted and predicted probabilities. The oETS$_F$ model produces the straight line for the probability of `r round(oETSFModel1$initial,2)`, ignoring the fact that in our example the probability of occurrence has increased over time.


### Odds ratio model, iETS$_O$
In this model, it is assumed that the update of the probability is driven by the occurrence of variable. It is more complicated than the previous as the probability now changes over time and can be modelled, for example, with ETS(M,N,N) model:
\begin{equation}
    \begin{aligned}
		& o_t \sim \text{Bernoulli} \left(p_t \right) \\
		& p_t = \frac{\mu_{a,t}}{\mu_{a,t}+1} \\
		& a_t = l_{a,t-1} \left(1 + \epsilon_{a,t} \right) \\
		& l_{a,t} = l_{a,t-1}( 1  + \alpha_{a} \epsilon_{a,t}) \\
		& \mu_{a,t} = l_{a,t-1}
    \end{aligned},
	(\#eq:oETSOddsMNN)
\end{equation}
where $l_{a,t}$ is the unobserved level component, $\alpha_{a}$ is the smoothing parameter, the error term $1+\epsilon_{a,t}$ is positive, has means of one and follows an unknown distribution and $\mu_{a,t}$is the conditional expectation for the unobservable shape parameters $a_t$. The measurement and transition equations in \@ref(eq:oETSOddsMNN) can be substituted by any other ADAM ETS or ARIMA model if it is reasonable to assume that the dynamics of probability has some additional components. This model is called ``odds ratio'', because the probability of occurrence in \@ref(eq:oETSOddsMNN) is calculated using the classical logistic transform. This also means that $\mu_{a,t}$ is equal to:
\begin{equation} \label{eq:iETS_O_oddsRatio}
	\mu_{a,t} = \frac{p_t}{1 - p_t} .
\end{equation}
When $\mu_{a,t}$ increases in the iETS\textsubscript{O} model, the odds ratio increases as well, meaning that the probability of occurrence goes up. @Svetunkov2019a explain that this model is in theory more appropriate for the demand on products becoming obsolescent, but given the updating mechanism it should also work fine on other types of intermittent demand data.

When it comes to the application of the model to the data, its construction is done via the following set of equations (example with oETS$_O$(M,N,N)):
\begin{equation}
    \begin{aligned}
        & \hat{p}_t = \frac{\hat{\mu}_{a,t}}{\hat{\mu}_{a,t}+1} \\
		& \hat{\mu}_{a,t} = \hat{l}_{a,t-1} \\
		& \hat{l}_{a,t} = \hat{l}_{a,t-1}( 1  + \hat{\alpha}_{a} e_{a,t}) \\
		& 1+e_{a,t} = \frac{u_t}{1-u_t} \\
		& u_{t} = \frac{1 + o_t - \hat{p}_t}{2}
    \end{aligned},
	(\#eq:oETSOddsMNNEstimated)
\end{equation}
where $e_{a,t}$ is the proxy for the unobservable error term $\epsilon_{a,t}$ and $\hat{\mu}_t$ is the estimate of $\mu_{a,t}$, conditional expectation discussed in Subsection \@ref(ETSTaxonomyMaths). If a multiple steps ahead forecast for the probability is needed from this model, then the formulae discussed in Subsection \@ref(ETSTaxonomyMaths) can be used to get $\hat{\mu}_{a,t}$, which then can be inserted in the first equation of \@ref(eq:oETSOddsMNNEstimated) to get the final conditional multiple steps ahead probability of occurrence.

Finally, in order to estimate the model \@ref(eq:oETSOddsMNNEstimated), the likelihood \@ref(eq:oETSLikelihood) can be used.

The occurrence part of the model iETS$_O$ is constructed using the very same `oes()` function, but also allows specifying the ETS model to use. For example, here is the oETS$_O$(M,M,N) model:
```{r iETSOExample1}
oETSOModel <- oes(y, model="MMN", occurrence="odds-ratio", h=10, holdout=TRUE)
oETSOModel
plot(oETSOModel)
```

The constructed model introduces the trend component, capturing the changing probability of occurrence and reflecting well the fact that it increases over time.


### Inverse odds ratio model, iETS$_I$
Using similar approach to the iETS$_O$ model, we can formulate the "inverse odds ration" model oETS$_I$(M,N,N):
\begin{equation}
    \begin{aligned}
		& o_t \sim \text{Bernoulli} \left(p_t \right) \\
		& p_t = \frac{1}{1+\mu_{b,t}} \\
		& b_t = l_{b,t-1} \left(1 + \epsilon_{b,t} \right) \\
		& l_{b,t} = l_{b,t-1}( 1  + \alpha_{b} \epsilon_{b,t}) \\
		& \mu_{b,t} = l_{b,t-1}
    \end{aligned},
	(\#eq:oETSInverseOddsMNN)
\end{equation}
where similarly to \@ref(eq:oETSOddsMNNEstimated), $l_{b,t}$ is the unobserved level component, $\alpha_{b}$ is the smoothing parameter, the error term $1+\epsilon_{b,t}$ is positive, has means of one and follows an unknown distribution and $\mu_{b,t}$is the conditional expectation for the unobservable shape parameters $b_t$. The main difference of this model with the previous is in the different mechanism of probability calculation, which focuses on the probability of "inoccurrence", i.e. on zeroes of data rather than on ones. This type of model should be more appropriate for cases of demand building up [@Svetunkov2019a]. The probability calculation mechanism in \@ref(eq:oETSInverseOddsMNN) implies that $\mu_{b,t}$ is equal to:
\begin{equation} \label{eq:iETS_O_oddsRatio}
	\mu_{b,t} = \frac{1-p_t}{p_t} .
\end{equation}

The construction of the model \@ref(eq:oETSInverseOddsMNN) is similar to \@ref(eq:oETSOddsMNNEstimated):
\begin{equation}
    \begin{aligned}
        & \hat{p}_t = \frac{1}{1+\hat{\mu}_{b,t}} \\
		& \hat{\mu}_{b,t} = \hat{l}_{b,t-1} \\
		& \hat{l}_{b,t} = l_{b,t-1}( 1  + \hat{\alpha}_{b} e_{b,t}) \\
		& 1+e_{b,t} = \frac{1-u_t}{u_t} \\
		& u_{t} = \frac{1 + o_t - \hat{p}_t}{2}
    \end{aligned},
	(\#eq:oETSInverseOddsMNNEstimated)
\end{equation}
where $e_{b,t}$ is the proxy for the unobservable error term $\epsilon_{b,t}$ and $\hat{\mu}_{b,t}$ is the estimate of $\mu_{b,t}$. Once again, we refer an interested reader to Subsection \@ref(ETSTaxonomyMaths) for the discussion of the multiple steps ahead conditional expectations from the model.

The function `oes()` implements the iETS$_I$ model as well. For example, here is the oETS$_I$(M,M,N) model:
```{r iETSIExample1}
oETSIModel <- oes(y, model="MMN", occurrence="inverse-odds-ratio", h=10, holdout=TRUE)
oETSIModel
plot(oETSIModel)
```

Similarly to the oETS$_O$, the model captures the trend in the probability of occurrence, but will have different smoothing parameters.


<!-- ### Inverse odds ratio model, iETS$_G$ -->


<!-- ### Inverse odds ratio model, iETS$_D$ -->



<!-- In the most general case, $p_t$ can be modelled using two ADAM models: -->
<!-- \begin{equation} -->
<!--     \begin{aligned} -->
<!-- 		& p_t = f(\mu_{a,t}, \mu_{b,t}) \\ -->
<!-- 		& a_t = w_a(\mathbf{v}_{a,t-\mathbf{l}}) + r_a(\mathbf{v}_{a,t-\mathbf{l}}) \epsilon_{a,t} \\ -->
<!-- 		& \mathbf{v}_{a,t} = f_a(\mathbf{v}_{a,t-\mathbf{l}}) + g_a(\mathbf{v}_{a,t-\mathbf{l}}) \epsilon_{a,t} \\ -->
<!-- 		& b_t = w_a(\mathbf{v}_{b,t-\mathbf{l}}) + r_a(\mathbf{v}_{b,t-\mathbf{l}}) \epsilon_{b,t} \\ -->
<!-- 		& \mathbf{v}_{b,t} = f_a(\mathbf{v}_{b,t-\mathbf{l}}) + g_a(\mathbf{v}_{b,t-\mathbf{l}}) \epsilon_{b,t} -->
<!--     \end{aligned} , -->
<!--   (\#eq:OccurrenceModelVeryGeneral) -->
<!-- \end{equation} -->
<!-- where $\epsilon_{a,t}$ and $\epsilon_{b,t}$ are the mutually independent error terms that follow unknown distribution, $\mu_{a,t}$ and $\mu_{b,t}$ are the conditional expectations for the unobservable shape parameters $a_t$ and $b_t$. Note that two models similar to the one discussed in Section \@ref(ADAMETSIntroduction) are used for modelling of $a_t$ and $b_t$. This more general form permits using any type of ADAM model, but we will focus on this chapter on [ADAM ETS](#ADAMETSIntroduction). Depending on what type of error is assumed in the ADAM ETS model for the occurrence part, the probability of occurrence will be calculated differently. The general formula for the multiplicative error is: -->
<!-- \begin{equation} -->
<!--     p_t = \frac{\mu_{a,t}}{\mu_{a,t}+\mu_{b,t}} , -->
<!--   (\#eq:oETSMZZ) -->
<!-- \end{equation} -->
<!-- while for the additive error, it is: -->
<!-- \begin{equation} -->
<!--     p_t = \frac{\exp(\mu_{a,t})}{\exp(\mu_{a,t})+\exp(\mu_{b,t})} . -->
<!--   (\#eq:oETSAZZ) -->
<!-- \end{equation} -->
<!-- This is because both $\mu_{a,t}$ and $\mu_{b,t}$ need to be strictly positive, while the additive error models support the real plane. The canonical iETS model assumes that the pure multiplicative model is used for the both $a_t$ and $b_t$. This type of model is positively defined for any values of error, trend and seasonality, which is essential for the values of $a_t$ and $b_t$ and their expectations. If a combination of additive and multiplicative error models is used, then the additive part is exponentiated prior to the usage of the formulae for the calculation of the probability. -->

<!-- An example of the occurrence part of an iETS model is the one for the basic local level model iETS(M,N,N)$_G$(M,N,N)(M,N,N): -->
<!-- \begin{equation} -->
<!--     \begin{aligned} -->
<!-- 		& o_t \sim \text{Bernoulli} \left(p_t \right) \\ -->
<!-- 		& p_t = \frac{\mu_{a,t}}{\mu_{a,t}+\mu_{b,t}} \\ -->
<!-- 		\\ -->
<!-- 		& a_t = l_{a,t-1} \left(1 + \epsilon_{a,t} \right) \\ -->
<!-- 		& l_{a,t} = l_{a,t-1}( 1  + \alpha_{a} \epsilon_{a,t}) \\ -->
<!-- 		& \mu_{a,t} = l_{a,t-1} \\ -->
<!-- 		\\ -->
<!-- 		& b_t = l_{b,t-1} \left(1 + \epsilon_{b,t} \right) \\ -->
<!-- 		& l_{b,t} = l_{b,t-1}( 1  + \alpha_{b} \epsilon_{b,t}) \\ -->
<!-- 		& \mu_{b,t} = l_{b,t-1} \\ -->
<!--     \end{aligned}, -->
<!--   (\#eq:iETSGExample) -->
<!-- \end{equation} -->
<!-- where $l_{a,t}$ and $l_{b,t}$ are the levels for each of the shape parameters and $\alpha_{a}$ and $\alpha_{b}$ are the smoothing parameters and the error terms $1+\epsilon_{a,t}$ and $1+\epsilon_{b,t}$ are positive and have means of one. We do not make any other distributional assumptions concerning the error terms. More advanced models can be constructing by specifying the ETS models for each part and / or adding explanatory variables. -->

<!-- In the notation of the model iETS(M,N,N)$_G$(M,N,N)(M,N,N), the first brackets describe the ETS model for the demand sizes, the underscore letter points out at the specific subtype of model (whic is discussed in the next subsections), the second brackets describe the ETS model, underlying the variable $a_t$ and the last ones stand for the model for the $b_t$. If only one variable is needed (either $a_t$ or $b_t$), then the redundant brackets are dropped, so that the notation simplifies, for example, to: iETS(M,N,N)$_O$(M,N,N). If the same type of model is used for both demand sizes and demand occurrence, then the second brackets can be dropped as well, simplifying this further to: iETS(M,N,N)$_G$. Furthermore, the notation without any brackets, such as iETS$_G$ stands for a general class of a specific subtype of iETS model (so any error / trend / seasonality). Also, given that iETS$_G$ is the most general model of all iETS models, the "$G$" can be dropped, when the properties are applicable to all subtypes. Finally, the "oETS" notation is used when the occurrence part of the model is discussed explicitly, skipping the demand sizes. -->

<!-- Depending on the restrictions on $a_t$ and $b_t$, there can be several types of iETS models: -->

<!-- 1. iETS$_F$: $\mu_{a,t} = \text{const}$, $\mu_{b,t} = \text{const}$ - the model with the fixed probability of occurrence; -->
<!-- 2. iETS$_O$: $\mu_{b,t} = 1$ - the "odds ratio" model, based on the logistic transform of the $o_t$ variable; -->
<!-- 3. iETS$_I$: $\mu_{a,t} = 1$ - the "inverse odds ratio" model, based on the inverse logistic transform of the $o_t$ variable; -->
<!-- 4. iETS$_D$: $\mu_{a,t} + \mu_{b,t} = 1$, $\mu_{a,t} \leq 1$ - the direct probability model, where the $p_t$ is calculated directly from the occurrence variable $o_t$; -->
<!-- 5. iETS$_G$: No restrictions - the model based on the evolution of both $\mu_{a,t}$ and $\mu_{b,t}$. -->



<!-- ## Demand sizes part of the model -->

<!-- ### Additive vs multiplicative error models -->

<!-- ## Conditional means and variance -->


<!-- ## Model estimation -->
<!-- The concentrated likelihood function for the iETS model is: -->
<!-- \begin{equation} \label{eq:LogNormalConcentratedLogLikelihood} \tag{2} -->
<!-- 	\ell(\boldsymbol{\theta}, \hat{\sigma}_\epsilon^2 | \textbf{Y}) = - \frac{1}{2} \left( T \log(2 \pi e \hat{\sigma}_\epsilon^2) + T_0 \right) - {\sum_{o_t=1}} \log(z_t) + {\sum_{o_t=1}} \log(\hat{p}_t) + {\sum_{o_t=0}} \log(1-\hat{p}_t) , -->
<!-- \end{equation} -->
<!-- where $\textbf{Y}$ is the vector of all the in-sample observations, $\boldsymbol{\theta}$ is the vector of parameters to estimate (initial values and smoothing parameters), $T$ is the number of all observations, $T_0$ is the number of zero observations, $\hat{\sigma_\epsilon}^2 = \frac{1}{T} \sum_{o_t=1} \log^2 \left(1 + \epsilon_t \right)$ is the scale parameter of the one-step-ahead forecast error for the demand sizes and $\hat{p}_t$ is the estimated probability of a non-zero demand at time $t$. This likelihood is used for the estimation of all the special cases of the iETS$_G$ model. -->



<!-- ## Intermittent ETS -->
<!-- Note that estimating seasonality on intermittent data is challenging -->

<!-- ## Other occurrence models -->
<!-- occurrence with provided values -->
<!-- occurrence estimated by alm() -->

